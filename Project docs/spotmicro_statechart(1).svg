<svg viewBox="0 0 1400 1100" xmlns="http://www.w3.org/2000/svg">
  <!-- Define styles -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#333" />
    </marker>
    <style>
      .state { fill: #f0f8ff; stroke: #333; stroke-width: 2; rx: 15; }
      .superstate { fill: #e6f3ff; stroke: #0066cc; stroke-width: 3; rx: 20; }
      .initial { fill: #000; }
      .history { fill: #fff; stroke: #333; stroke-width: 2; }
      .text { font-family: Arial, sans-serif; font-size: 14px; fill: #333; }
      .title { font-family: Arial, sans-serif; font-size: 16px; font-weight: bold; fill: #0066cc; }
      .label { font-family: Arial, sans-serif; font-size: 12px; fill: #333; }
      .small { font-family: Arial, sans-serif; font-size: 11px; fill: #333; }
      .transition { stroke: #333; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .dashed { stroke-dasharray: 5,5; stroke: #666; stroke-width: 2; }
      .note { font-family: Arial, sans-serif; font-size: 12px; fill: #cc0000; font-weight: bold; }
    </style>
  </defs>

  <!-- Main Title -->
  <text x="700" y="30" class="title" text-anchor="middle" font-size="20">SpotMicro Robot System - State Chart</text>
  
  <!-- System Superstate -->
  <rect x="20" y="50" width="1360" height="1030" class="superstate"/>
  <text x="40" y="75" class="title">SpotMicro System</text>
  
  <!-- Power Off State -->
  <rect x="50" y="100" width="200" height="120" class="state"/>
  <text x="150" y="125" class="text" text-anchor="middle" font-weight="bold">Power Off</text>
  <line x1="50" y1="135" x2="250" y2="135" stroke="#333" stroke-width="1"/>
  <text x="60" y="155" class="small">entry/</text>
  <text x="60" y="170" class="small">  All servos OFF</text>
  <text x="60" y="185" class="small">  OLED: "SHUTDOWN"</text>
  <text x="60" y="200" class="small">  Tail motor OFF</text>
  
  <!-- Initial state marker -->
  <circle cx="150" cy="60" r="8" class="initial"/>
  <line x1="150" y1="68" x2="150" y2="100" class="transition"/>
  
  <!-- Operating Superstate -->
  <rect x="320" y="100" width="1040" height="950" class="superstate"/>
  <text x="340" y="125" class="title">Operating State</text>
  
  <!-- Deep History marker -->
  <circle cx="380" cy="160" r="15" class="history"/>
  <text x="380" y="167" text-anchor="middle" font-weight="bold">H*</text>
  
  <!-- Transition from Power Off to Operating -->
  <path d="M 250 160 L 320 160" class="transition"/>
  <text x="265" y="150" class="label">[Rocker=ON]</text>
  
  <!-- Transition from Operating to Power Off -->
  <path d="M 320 200 L 250 200" class="transition"/>
  <text x="265" y="190" class="label">[Rocker=OFF]</text>
  
  <!-- HIERARCHY: Three Parallel Subsystems (Orthogonality) -->
  
  <!-- ========== SUBSYSTEM 1: Balance & Locomotion (Sequential) ========== -->
  <rect x="340" y="190" width="980" height="270" class="superstate"/>
  <text x="360" y="215" class="title">Subsystem 1: Balance &amp; Locomotion (Sequential)</text>
  
  <!-- Calibrating State -->
  <rect x="360" y="230" width="180" height="100" class="state"/>
  <text x="450" y="255" class="text" text-anchor="middle" font-weight="bold">Calibrating</text>
  <line x1="360" y1="265" x2="540" y2="265" stroke="#333" stroke-width="1"/>
  <text x="370" y="280" class="small">entry/</text>
  <text x="370" y="295" class="small">  Init IMU</text>
  <text x="370" y="310" class="small">  OLED: "CAL..."</text>
  
  <!-- Initial for Subsystem 1 -->
  <circle cx="400" cy="200" r="6" class="initial"/>
  <line x1="400" y1="206" x2="400" y2="230" class="transition"/>
  
  <!-- Stand State -->
  <rect x="580" y="230" width="160" height="110" class="state"/>
  <text x="660" y="255" class="text" text-anchor="middle" font-weight="bold">Stand</text>
  <line x1="580" y1="265" x2="740" y2="265" stroke="#333" stroke-width="1"/>
  <text x="590" y="280" class="small">entry/</text>
  <text x="590" y="295" class="small">  Default pose</text>
  <text x="590" y="310" class="small">do/</text>
  <text x="590" y="325" class="small">  Balance loop</text>
  
  <path d="M 540 280 L 580 280" class="transition"/>
  <text x="545" y="270" class="small">after(3s)</text>
  
  <!-- Walking State -->
  <rect x="780" y="230" width="160" height="110" class="state"/>
  <text x="860" y="255" class="text" text-anchor="middle" font-weight="bold">Walking</text>
  <line x1="780" y1="265" x2="940" y2="265" stroke="#333" stroke-width="1"/>
  <text x="790" y="280" class="small">entry/</text>
  <text x="790" y="295" class="small">  Gait cycle</text>
  <text x="790" y="310" class="small">do/</text>
  <text x="790" y="325" class="small">  Balance loop</text>
  
  <path d="M 740 270 L 780 270" class="transition"/>
  <text x="745" y="260" class="small">[WALK_FWD]</text>
  
  <path d="M 780 310 L 740 310" class="transition"/>
  <text x="745" y="330" class="small">[STOP]</text>
  
  <!-- Turning State -->
  <rect x="980" y="230" width="160" height="110" class="state"/>
  <text x="1060" y="255" class="text" text-anchor="middle" font-weight="bold">Turning</text>
  <line x1="980" y1="265" x2="1140" y2="265" stroke="#333" stroke-width="1"/>
  <text x="990" y="280" class="small">entry/ angle:=X</text>
  <text x="990" y="295" class="small">do/</text>
  <text x="990" y="310" class="small">  Turn gait</text>
  <text x="990" y="325" class="small">  Balance loop</text>
  
  <path d="M 940 260 L 980 260" class="transition"/>
  <text x="945" y="250" class="small">[TURN_X]</text>
  
  <path d="M 980 300 L 940 300" class="transition"/>
  <text x="945" y="320" class="small">after(turn)</text>
  
  <!-- Emergency Stop State -->
  <rect x="1170" y="230" width="130" height="110" class="state"/>
  <text x="1235" y="255" class="text" text-anchor="middle" font-weight="bold">E-Stop</text>
  <line x1="1170" y1="265" x2="1300" y2="265" stroke="#333" stroke-width="1"/>
  <text x="1180" y="280" class="small">entry/</text>
  <text x="1180" y="295" class="small">  Freeze all</text>
  <text x="1180" y="310" class="small">  OLED:</text>
  <text x="1180" y="325" class="small">  "DANGER!"</text>
  
  <!-- Broadcasting arrow from E-Stop -->
  <path d="M 1235 230 L 1235 190" class="transition" stroke="#cc0000" stroke-width="3"/>
  <text x="1240" y="215" class="note">[DROP_OFF]</text>
  <text x="1240" y="180" class="note">BROADCAST</text>
  
  <!-- ORTHOGONALITY SEPARATOR -->
  <line x1="340" y1="480" x2="1320" y2="480" class="dashed"/>
  
  <!-- ========== SUBSYSTEM 2: Autonomous Navigation (Parallel) ========== -->
  <rect x="340" y="500" width="640" height="280" class="superstate"/>
  <text x="360" y="525" class="title">Subsystem 2: Autonomous Navigation (Parallel)</text>
  
  <!-- Idle Navigation State -->
  <rect x="360" y="545" width="140" height="90" class="state"/>
  <text x="430" y="570" class="text" text-anchor="middle" font-weight="bold">Nav Idle</text>
  <line x1="360" y1="580" x2="500" y2="580" stroke="#333" stroke-width="1"/>
  <text x="370" y="595" class="small">entry/</text>
  <text x="370" y="610" class="small">  Sensors OFF</text>
  <text x="370" y="625" class="small">  OLED: "IDLE"</text>
  
  <!-- Initial for Subsystem 2 -->
  <circle cx="400" cy="515" r="6" class="initial"/>
  <line x1="400" y1="521" x2="400" y2="545" class="transition"/>
  
  <!-- Patrolling State with substates (HIERARCHY) -->
  <rect x="540" y="545" width="420" height="220" class="superstate"/>
  <text x="560" y="570" class="title">Patrolling</text>
  
  <!-- Shallow History -->
  <circle cx="600" cy="595" r="12" class="history"/>
  <text x="600" y="601" text-anchor="middle" font-weight="bold">H</text>
  
  <!-- Sensing Substate -->
  <rect x="560" y="610" width="170" height="80" class="state"/>
  <text x="645" y="635" class="text" text-anchor="middle" font-weight="bold">Sensing</text>
  <line x1="560" y1="645" x2="730" y2="645" stroke="#333" stroke-width="1"/>
  <text x="570" y="660" class="small">do/</text>
  <text x="570" y="675" class="small">  Ultrasonic ping</text>
  
  <!-- Initial for Patrol -->
  <circle cx="600" cy="580" r="5" class="initial"/>
  <line x1="600" y1="585" x2="600" y2="610" class="transition"/>
  
  <!-- Avoiding Substate -->
  <rect x="760" y="610" width="180" height="80" class="state"/>
  <text x="850" y="635" class="text" text-anchor="middle" font-weight="bold">Avoiding</text>
  <line x1="760" y1="645" x2="940" y2="645" stroke="#333" stroke-width="1"/>
  <text x="770" y="660" class="small">entry/ Send TURN</text>
  <text x="770" y="675" class="small">OLED: "AVOIDING"</text>
  
  <path d="M 730 650 L 760 650" class="transition"/>
  <text x="735" y="640" class="small">[dist&lt;20cm]</text>
  
  <path d="M 760 670 L 730 670" class="transition"/>
  <text x="735" y="690" class="small">after(turn)</text>
  
  <!-- Transition Idle to Patrol -->
  <path d="M 500 590 L 540 590" class="transition"/>
  <text x="505" y="580" class="small">[PATROL]</text>
  
  <!-- Transition Patrol to Idle -->
  <path d="M 540 610 L 500 610" class="transition"/>
  <text x="505" y="630" class="small">[STOP_CMD]</text>
  
  <!-- Drop-off detected (broadcasting) -->
  <path d="M 850 610 L 850 545" class="transition" stroke="#cc0000" stroke-width="3"/>
  <text x="855" y="580" class="note">[STEREO_DROP]</text>
  
  <!-- ORTHOGONALITY SEPARATOR -->
  <line x1="340" y1="800" x2="1320" y2="800" class="dashed"/>
  
  <!-- ========== SUBSYSTEM 3: MQTT Control (Parallel) ========== -->
  <rect x="340" y="820" width="640" height="230" class="superstate"/>
  <text x="360" y="845" class="title">Subsystem 3: Remote MQTT Control (Parallel)</text>
  
  <!-- Disconnected State -->
  <rect x="360" y="865" width="150" height="90" class="state"/>
  <text x="435" y="890" class="text" text-anchor="middle" font-weight="bold">Disconnected</text>
  <line x1="360" y1="900" x2="510" y2="900" stroke="#333" stroke-width="1"/>
  <text x="370" y="915" class="small">entry/</text>
  <text x="370" y="930" class="small">  WiFi OFF</text>
  <text x="370" y="945" class="small">  OLED: "NO MQTT"</text>
  
  <!-- Initial for Subsystem 3 -->
  <circle cx="400" cy="835" r="6" class="initial"/>
  <line x1="400" y1="841" x2="400" y2="865" class="transition"/>
  
  <!-- Connected State -->
  <rect x="550" y="865" width="170" height="110" class="state"/>
  <text x="635" y="890" class="text" text-anchor="middle" font-weight="bold">MQTT Connected</text>
  <line x1="550" y1="900" x2="720" y2="900" stroke="#333" stroke-width="1"/>
  <text x="560" y="915" class="small">entry/ Connect</text>
  <text x="560" y="930" class="small">do/</text>
  <text x="560" y="945" class="small">  Listen to topics</text>
  <text x="560" y="960" class="small">  Parse commands</text>
  
  <path d="M 510 910 L 550 910" class="transition"/>
  <text x="515" y="900" class="small">[WiFi OK]</text>
  
  <path d="M 550 930 L 510 930" class="transition"/>
  <text x="515" y="950" class="small">[WiFi Lost]</text>
  
  <!-- Tail Wag State -->
  <rect x="760" y="865" width="150" height="90" class="state"/>
  <text x="835" y="890" class="text" text-anchor="middle" font-weight="bold">Tail Wagging</text>
  <line x1="760" y1="900" x2="910" y2="900" stroke="#333" stroke-width="1"/>
  <text x="770" y="915" class="small">entry/</text>
  <text x="770" y="930" class="small">  DC motor ON</text>
  <text x="770" y="945" class="small">exit/ Motor OFF</text>
  
  <path d="M 720 890 L 760 890" class="transition"/>
  <text x="725" y="880" class="small">[TAIL_WAG]</text>
  
  <path d="M 760 920 L 720 920" class="transition"/>
  <text x="725" y="940" class="small">after(2s)</text>
  
  <!-- Broadcasting from MQTT to other subsystems -->
  <path d="M 635 865 L 635 820" class="transition" stroke="#00cc00" stroke-width="2"/>
  <text x="640" y="840" class="note" fill="#00cc00">Commands Broadcast</text>
  <text x="640" y="855" class="small" fill="#00cc00">to all subsystems</text>
  
  <!-- Legend Box -->
  <rect x="1020" y="820" width="300" height="230" class="state" fill="#fffacd"/>
  <text x="1170" y="845" class="title" text-anchor="middle">Legend &amp; Concepts</text>
  <line x1="1020" y1="855" x2="1320" y2="855" stroke="#333" stroke-width="2"/>
  
  <text x="1030" y="875" class="small" font-weight="bold">✓ HIERARCHY:</text>
  <text x="1040" y="890" class="small">Superstates contain substates</text>
  <text x="1040" y="905" class="small">(e.g., Patrolling → Sensing/Avoiding)</text>
  
  <text x="1030" y="925" class="small" font-weight="bold">✓ ORTHOGONALITY:</text>
  <text x="1040" y="940" class="small">3 subsystems run concurrently</text>
  <text x="1040" y="955" class="small">(separated by dashed lines)</text>
  
  <text x="1030" y="975" class="small" font-weight="bold">✓ BROADCASTING:</text>
  <text x="1040" y="990" class="small">Events trigger multiple subsystems</text>
  <text x="1040" y="1005" class="small">(e.g., DROP_OFF, MQTT commands)</text>
  
  <text x="1030" y="1025" class="small" font-weight="bold">✓ HISTORY:</text>
  <text x="1040" y="1040" class="small">H* = Deep history (all levels)</text>
  <text x="1040" y="1055" class="small">H = Shallow history (one level)</text>
</svg>